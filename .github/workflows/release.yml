name: Release

on:
  release:
    types: [published]

permissions:
  contents: write

env:
  GITHUB_REPO: semos-labs/epist
  HOMEBREW_TAP: semos-labs/homebrew-tap

jobs:
  build:
    name: Build (${{ matrix.target }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: bun-linux-x64
            artifact: epist-linux-x64
            strip: true
          - os: ubuntu-latest
            target: bun-linux-arm64
            artifact: epist-linux-arm64
            strip: true
          - os: macos-latest
            target: bun-darwin-x64
            artifact: epist-darwin-x64
            strip: false  # cross-compiled, code signature can't be removed
          - os: macos-latest
            target: bun-darwin-arm64
            artifact: epist-darwin-arm64
            strip: true

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.4"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build binary
        run: |
          bun build --compile --minify --sourcemap=none --target=${{ matrix.target }} src/index.tsx --outfile ${{ matrix.artifact }} \
            --define __epist_GOOGLE_CLIENT_ID__="'${{ secrets.GOOGLE_CLIENT_ID }}'" \
            --define __epist_GOOGLE_CLIENT_SECRET__="'${{ secrets.GOOGLE_CLIENT_SECRET }}'"
        env:
          # Fallback in case secrets aren't set
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID || '' }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET || '' }}

      - name: Cache LLVM (Linux)
        if: matrix.strip && runner.os == 'Linux'
        id: cache-llvm-linux
        uses: actions/cache@v4
        with:
          path: /usr/lib/llvm-*
          key: llvm-linux-${{ runner.arch }}

      - name: Install llvm-strip (Linux)
        if: matrix.strip && runner.os == 'Linux' && steps.cache-llvm-linux.outputs.cache-hit != 'true'
        run: sudo apt-get install -y llvm

      - name: Strip binary (Linux)
        if: matrix.strip && runner.os == 'Linux'
        run: llvm-strip ${{ matrix.artifact }}

      - name: Install llvm-strip (macOS)
        if: matrix.strip && runner.os == 'macOS'
        run: brew install llvm

      - name: Strip binary (macOS)
        if: matrix.strip && runner.os == 'macOS'
        run: $(brew --prefix llvm)/bin/llvm-strip ${{ matrix.artifact }}

      - name: Make executable
        run: chmod +x ${{ matrix.artifact }}

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ matrix.artifact }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    name: Update Homebrew Tap
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Get version from release
        id: version
        run: |
          VERSION=${{ github.event.release.tag_name }}
          VERSION=${VERSION#v}  # Remove 'v' prefix
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"

      - name: Wait for release assets to be available
        run: |
          echo "Waiting for release assets..."
          sleep 30

      - name: Download and calculate SHA256 checksums
        id: sha256
        run: |
          VERSION=${{ steps.version.outputs.version }}
          BASE_URL="https://github.com/${{ env.GITHUB_REPO }}/releases/download/v${VERSION}"

          echo "Downloading binaries and calculating checksums..."

          # Function to download and get SHA256 (debug output to stderr)
          get_sha256() {
            local url="$1"
            local name="$2"
            echo "Downloading ${name}..." >&2
            SHA=$(curl -sfL "${url}" | sha256sum | cut -d' ' -f1)
            if [ -z "$SHA" ] || [ "$SHA" = "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855" ]; then
              echo "Error: Failed to download ${name} or file is empty" >&2
              exit 1
            fi
            echo "${name}: ${SHA}" >&2
            echo "$SHA"
          }

          SHA_DARWIN_ARM64=$(get_sha256 "${BASE_URL}/epist-darwin-arm64" "darwin-arm64")
          SHA_DARWIN_X64=$(get_sha256 "${BASE_URL}/epist-darwin-x64" "darwin-x64")
          SHA_LINUX_ARM64=$(get_sha256 "${BASE_URL}/epist-linux-arm64" "linux-arm64")
          SHA_LINUX_X64=$(get_sha256 "${BASE_URL}/epist-linux-x64" "linux-x64")

          echo "darwin_arm64=${SHA_DARWIN_ARM64}" >> $GITHUB_OUTPUT
          echo "darwin_x64=${SHA_DARWIN_X64}" >> $GITHUB_OUTPUT
          echo "linux_arm64=${SHA_LINUX_ARM64}" >> $GITHUB_OUTPUT
          echo "linux_x64=${SHA_LINUX_X64}" >> $GITHUB_OUTPUT

          echo ""
          echo "All checksums calculated successfully!"

      - name: Trigger Homebrew tap update
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          repository: ${{ env.HOMEBREW_TAP }}
          event-type: update-formula
          client-payload: >-
            {
              "formula": "epist",
              "version": "${{ steps.version.outputs.version }}",
              "sha256_darwin_arm64": "${{ steps.sha256.outputs.darwin_arm64 }}",
              "sha256_darwin_x64": "${{ steps.sha256.outputs.darwin_x64 }}",
              "sha256_linux_arm64": "${{ steps.sha256.outputs.linux_arm64 }}",
              "sha256_linux_x64": "${{ steps.sha256.outputs.linux_x64 }}"
            }

      - name: Summary
        run: |
          echo "## Homebrew Tap Update Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Version: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checksums" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | SHA256 |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| darwin-arm64 | \`${{ steps.sha256.outputs.darwin_arm64 }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| darwin-x64 | \`${{ steps.sha256.outputs.darwin_x64 }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| linux-arm64 | \`${{ steps.sha256.outputs.linux_arm64 }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| linux-x64 | \`${{ steps.sha256.outputs.linux_x64 }}\` |" >> $GITHUB_STEP_SUMMARY
